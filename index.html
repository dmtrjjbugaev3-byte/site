<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>12x12 Realtime</title>
<style>
/* ... твои стили без изменений ... */
</style>

<!-- Подключаем Pusher SDK -->
<script src="https://js.pusher.com/8.2/pusher.min.js"></script>
<script>
  const PUSHER_KEY = "6ead994314cfeaa97dc6";
  const PUSHER_CLUSTER = "eu";

  const CLIENT_ID = (() => {
    const k = 'clientId';
    let id = localStorage.getItem(k);
    if (!id) { id = 'c_' + Math.random().toString(36).slice(2) + Date.now().toString(36); localStorage.setItem(k, id); }
    return id;
  })();

  const pusher = new Pusher(PUSHER_KEY, { cluster: PUSHER_CLUSTER });
  const channel = pusher.subscribe("game-channel");
</script>
</head>
<body>

<div id="app"></div>

<script>
(function(){
  const LEFT_TABLES=12, RIGHT_TABLES=12, LEFT_SLOTS=7, RIGHT_SLOTS=6;

  let state = {
    tablesLeft:  [],
    tablesRight: [],
    players:     {},
    bench:       []
  };

  let isApplyingRemote = false;
  let broadcastTimer = null;
  const BROADCAST_DEBOUNCE = 150;

  function scheduleBroadcast(){
    if (isApplyingRemote) return;
    clearTimeout(broadcastTimer);
    broadcastTimer = setTimeout(sendStateUpdate, BROADCAST_DEBOUNCE);
  }

  async function sendStateUpdate(){
    try {
      await fetch("/api/update-state", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ state, senderId: CLIENT_ID })
      });
    } catch (e) {
      console.warn("Broadcast failed:", e);
    }
  }

  channel.bind("state-update", (data) => {
    if (!data || !data.state) return;
    if (data.senderId && data.senderId === CLIENT_ID) return;
    isApplyingRemote = true;
    state = data.state;
    render();
    isApplyingRemote = false;
  });

  function init(){
    for(let i=0;i<LEFT_TABLES;i++) state.tablesLeft.push([]);
    for(let i=0;i<RIGHT_TABLES;i++) state.tablesRight.push([]);
  }

  function render(){
    const app = document.getElementById('app');
    app.innerHTML = JSON.stringify(state, null, 2);
  }

  // Пример изменения state
  function addPlayer(name){
    state.players[name] = { name };
    state.tablesLeft[0].push(name);
    render();
    scheduleBroadcast();
  }

  init();
  render();

  // Для теста добавим игрока через 3 секунды
  setTimeout(()=>addPlayer("Игрок 1"), 3000);

})();
</script>
</body>
</html>
